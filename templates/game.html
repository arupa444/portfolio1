{% extends "base.html" %}

{% block content %}
<!-- Font for the Game (Orbitron looks Cyberpunk) -->
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">

<style>
    /* Game Specific Styles */
    .game-font { font-family: 'Orbitron', sans-serif; }

    .scanline {
        position: fixed;
        left: 0; top: 0; width: 100%; height: 100%;
        background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
        background-size: 100% 4px;
        pointer-events: none;
        z-index: 50;
        opacity: 0.3;
    }

    .vignette {
        position: fixed;
        left: 0; top: 0; width: 100%; height: 100%;
        background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
        pointer-events: none;
        z-index: 49;
    }

    /* Info Modal Animation */
    @keyframes slideIn {
        from { transform: translateY(50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    .modal-anim { animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

    .glitch-btn:hover {
        animation: glitch-anim 0.3s infinite;
        background-color: #fff;
        color: #000;
    }
    @keyframes glitch-anim {
        0% { transform: translate(0) }
        20% { transform: translate(-2px, 2px) }
        40% { transform: translate(-2px, -2px) }
        60% { transform: translate(2px, 2px) }
        80% { transform: translate(2px, -2px) }
        100% { transform: translate(0) }
    }
</style>

<div class="fixed inset-0 w-full h-full bg-[#050505] overflow-hidden select-none">

    <!-- CRT Effects -->
    <div class="scanline"></div>
    <div class="vignette"></div>

    <!-- HUD -->
    <div class="absolute top-24 left-0 w-full px-8 flex justify-between items-start z-40 pointer-events-none">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-widest game-font italic text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">NEURAL DASH</h1>
            <div class="flex items-center gap-2 mt-2">
                <div class="w-32 h-2 bg-gray-800 rounded-full overflow-hidden border border-white/10">
                    <div id="progressBar" class="h-full bg-gradient-to-r from-primary to-secondary w-0 transition-all duration-300"></div>
                </div>
                <span class="text-xs text-primary font-mono" id="progressText">0%</span>
            </div>
        </div>
        <div class="text-right">
            <p class="text-5xl game-font font-black text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]" id="levelDisplay">LVL 01</p>
            <p class="text-gray-400 text-xs font-mono tracking-widest mt-1">ATTEMPT <span id="attemptDisplay">1</span></p>
        </div>
    </div>

    <!-- Canvas -->
    <canvas id="gameCanvas" class="block w-full h-full z-10"></canvas>

    <!-- Start Screen -->
    <div id="startScreen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-black/90 backdrop-blur-sm transition-opacity duration-500">
        <div class="text-center space-y-6">
            <h1 class="text-6xl md:text-8xl font-black text-white game-font italic tracking-tighter drop-shadow-[0_0_30px_rgba(168,85,247,0.8)]">
                NEURAL<span class="text-primary">DASH</span>
            </h1>
            <p class="text-gray-300 font-mono text-sm md:text-base max-w-md mx-auto leading-relaxed">
                Syncing with neural pathways...<br>
                Avoid the <span class="text-red-500 font-bold">Red Spikes</span>.<br>
                Complete <span class="text-secondary font-bold">10 Sectors</span> to download Arupa's data.
            </p>
            <button onclick="Game.start()" class="glitch-btn px-12 py-4 bg-primary text-white font-bold text-xl rounded clip-path-polygon hover:shadow-[0_0_30px_rgba(168,85,247,0.6)] transition-all game-font tracking-widest uppercase border border-white/20">
                Initiate
            </button>
            <p class="text-xs text-gray-500 font-mono animate-pulse">PRESS [SPACE] OR TAP TO JUMP</p>
        </div>
    </div>

    <!-- Info Modal (Level Complete) -->
    <div id="infoModal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-md p-4">
        <div class="modal-anim max-w-3xl w-full bg-[#0F0B1E] border-2 border-primary/50 rounded-xl shadow-[0_0_100px_rgba(168,85,247,0.2)] overflow-hidden relative">
            <!-- Background Matrix Effect -->
            <div class="absolute inset-0 opacity-10 bg-[url('https://media.giphy.com/media/U3qYN8S0j3bpK/giphy.gif')] bg-cover"></div>

            <div class="relative z-10 p-8 md:p-12">
                <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-4">
                    <h2 class="text-3xl font-black text-white game-font italic">
                        SECTOR <span id="modalLevelNum" class="text-primary">01</span> <span class="text-gray-500 text-lg not-italic font-mono ml-2">/ CLEARED</span>
                    </h2>
                    <div class="h-3 w-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e] animate-pulse"></div>
                </div>

                <div class="space-y-4 mb-10">
                    <h3 id="modalTitle" class="text-2xl font-bold text-white font-mono">Identity Verified</h3>
                    <p id="modalDesc" class="text-gray-300 text-lg leading-relaxed border-l-4 border-secondary pl-4">
                        Loading data...
                    </p>
                </div>

                <div class="flex justify-end">
                    <button onclick="Game.nextLevel()" class="px-8 py-3 bg-white text-black font-bold font-mono rounded hover:bg-primary hover:text-white transition-all transform hover:scale-105 shadow-lg">
                        RESUME SEQUENCE >>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Over -->
    <div id="gameOver" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-red-900/40 backdrop-blur-sm">
        <h2 class="text-7xl font-black text-white game-font italic mb-2 text-shadow-red">CRASHED</h2>
        <p class="text-white font-mono mb-8 bg-red-600/20 px-4 py-2 rounded border border-red-500/50">FATAL EXCEPTION AT SECTOR <span id="failLevel">01</span></p>
        <button onclick="Game.restartLevel()" class="px-10 py-3 bg-red-600 text-white font-bold rounded hover:bg-red-500 transition-all shadow-[0_0_30px_rgba(220,38,38,0.5)] game-font tracking-wider">
            RETRY SECTOR
        </button>
    </div>

</div>

<script>
// --- GAME ENGINE (PATCHED v2.0) ---

const LEVEL_DATA = [
    { title: "WHO AM I?", desc: "I am Arupa Nanda Swain. An AI Engineer bridging the gap between deep mathematical research and high-scale production systems." },
    { title: "EDUCATION", desc: "B.Tech in Computer Science (Honors) from XIM University. Focused on Algorithms, Data Structures, and Computational Mathematics." },
    { title: "THE R&D FOUNDATION", desc: "Spent 2 years in Research inventing 'Contiguous Clustering' (CC)â€”a sparse matrix format 10x faster than standard CSR using C++." },
    { title: "PRODUCTION ENGINEERING", desc: "Currently at OMICS International USA. Built GenAI pipelines reducing manual journal publishing workloads by 60%." },
    { title: "SYSTEMS AT SCALE", desc: "Built 'The Little Journal' platform for Times of India clients. Engineered a real-time 'Truth Lens' Fake News Detector." },
    { title: "PROJECT: JOURNAL AI", desc: "Compound AI system using Gemini 2.5 & Groq. Automates research papers from metadata to final PDF compilation." },
    { title: "PROJECT: SWARA VISION", desc: "Built a Computer Vision system using Custom CNNs to read Indian Classical Music notation with 96% accuracy." },
    { title: "CORE SKILLS: AI", desc: "LLMs (Llama, Gemini), RAG Architectures, LangChain, TensorFlow, PyTorch, and Vector Databases." },
    { title: "CORE SKILLS: BACKEND", desc: "Expert in Python (FastAPI/Flask), C++ (High Performance), Docker, Linux, and Cloud Deployment." },
    { title: "HIRE ME", desc: "You've seen the data.<br><strong>Phone:</strong> +91 7735460467<br><strong>Email:</strong> arupaswain7735@gmail.com" }
];

const CANVAS = document.getElementById('gameCanvas');
const CTX = CANVAS.getContext('2d');

// --- AUDIO SYSTEM ---
const Audio = {
    ctx: new (window.AudioContext || window.webkitAudioContext)(),
    jump() {
        if (this.ctx.state === 'suspended') this.ctx.resume();
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.frequency.setValueAtTime(150, this.ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(600, this.ctx.currentTime + 0.1);
        g.gain.setValueAtTime(0.1, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.1);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + 0.1);
    },
    crash() {
        const o = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(100, this.ctx.currentTime);
        o.frequency.exponentialRampToValueAtTime(10, this.ctx.currentTime + 0.3);
        g.gain.setValueAtTime(0.2, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.3);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime + 0.3);
    }
};

class Player {
    constructor() {
        this.size = 40;
        this.x = 100;
        this.y = 0;
        this.dy = 0;
        this.rotation = 0;
        this.grounded = false;
        this.trail = [];
    }

    update() {
        // Physics
        this.dy += 0.8; // Gravity
        this.y += this.dy;

        // Ground Collision
        const floorY = CANVAS.height - 150 - this.size;
        if (this.y > floorY) {
            this.y = floorY;
            this.dy = 0;
            this.grounded = true;
            // Snap rotation to nearest 90
            const r = this.rotation % (Math.PI/2);
            if(Math.abs(r) > 0.05) {
                this.rotation = Math.round(this.rotation / (Math.PI/2)) * (Math.PI/2);
            }
        } else {
            this.grounded = false;
            this.rotation += 0.15; // Spin when jumping
        }

        // Trail Logic
        if (this.grounded === false || Math.random() > 0.5) {
            this.trail.push({x: this.x, y: this.y, r: this.rotation, a: 0.5});
        }
        if(this.trail.length > 8) this.trail.shift();
    }

    draw() {
        // Draw Trail
        this.trail.forEach(t => {
            CTX.save();
            CTX.translate(t.x + 20, t.y + 20);
            CTX.rotate(t.r);
            CTX.fillStyle = `rgba(168, 85, 247, ${t.a})`;
            CTX.fillRect(-20, -20, 40, 40);
            CTX.restore();
            t.a -= 0.05;
        });

        // Draw Cube
        CTX.save();
        CTX.translate(this.x + 20, this.y + 20);
        CTX.rotate(this.rotation);
        CTX.fillStyle = '#A855F7'; // Purple
        CTX.shadowBlur = 20;
        CTX.shadowColor = '#A855F7';
        CTX.fillRect(-20, -20, 40, 40);

        // Face Detail (Eye)
        CTX.fillStyle = 'white';
        CTX.fillRect(5, -5, 12, 12);
        CTX.restore();
    }

    jump() {
        if(this.grounded) {
            this.dy = -14; // Stronger Jump
            this.grounded = false;
            Audio.jump();
        }
    }
}

class Obstacle {
    constructor(x, type) {
        this.x = x;
        this.type = type; // 'spike' or 'block'
        this.w = 40;
        this.h = type === 'spike' ? 40 : 60;
        this.marked = false;
    }

    update(speed) {
        this.x -= speed;
        if (this.x < -100) this.marked = true;
    }

    draw() {
        CTX.save();
        const floorY = CANVAS.height - 150;
        CTX.translate(this.x, floorY - this.h);

        CTX.shadowBlur = 15;
        CTX.shadowColor = '#ef4444'; // Red Glow
        CTX.fillStyle = '#ef4444';

        if(this.type === 'spike') {
            CTX.beginPath();
            CTX.moveTo(0, 40);
            CTX.lineTo(20, 0);
            CTX.lineTo(40, 40);
            CTX.fill();
        } else {
            CTX.fillRect(0, 0, 40, 60);
            // Block Detail
            CTX.fillStyle = '#7f1d1d';
            CTX.fillRect(10, 10, 20, 40);
        }
        CTX.restore();
    }

    collide(p) {
        // Hitbox padding for fairness
        const pad = 8;
        const floorY = CANVAS.height - 150;

        const ox = this.x + pad;
        const oy = floorY - this.h + pad;
        const ow = this.w - (pad*2);
        const oh = this.h - (pad*2);

        const px = p.x + pad;
        const py = p.y + pad;
        const ps = p.size - (pad*2);

        return (px < ox + ow && px + ps > ox && py < oy + oh && py + ps > oy);
    }
}

const Game = {
    state: 'MENU',
    level: 1,
    score: 0,
    speed: 8,
    attempt: 1,
    player: null,
    obstacles: [],

    start() {
        document.getElementById('startScreen').style.display = 'none';
        this.resize();
        window.addEventListener('resize', () => this.resize());

        // Input Handling
        const jump = (e) => {
            if(this.state === 'PLAY') {
               // Allow Space, ArrowUp, Click, Tap
               if(e.type === 'keydown' && e.code !== 'Space' && e.code !== 'ArrowUp') return;
               this.player.jump();
            }
        };
        window.addEventListener('keydown', jump);
        window.addEventListener('mousedown', jump);
        window.addEventListener('touchstart', (e) => { e.preventDefault(); jump(e); });

        this.resetLevel();
        this.loop();
    },

    resize() {
        CANVAS.width = window.innerWidth;
        CANVAS.height = window.innerHeight;
    },

    resetLevel() {
        document.getElementById('gameOver').classList.add('hidden');
        this.player = new Player();
        this.obstacles = [];
        this.score = 0;
        this.state = 'PLAY';

        // Force spawn an initial obstacle so player sees something immediately
        setTimeout(() => {
            if(this.state === 'PLAY') this.obstacles.push(new Obstacle(CANVAS.width + 100, 'spike'));
        }, 1000);

        this.updateHUD();
    },

    nextLevel() {
        document.getElementById('infoModal').classList.add('hidden');
        if(this.level >= 10) { window.location.href = '/#contact'; return; }
        this.level++;
        this.speed += 1; // Increase speed per level
        this.resetLevel();
    },

    // --- FIXED SPAWN LOGIC ---
    spawnObstacle() {
        // 1. Get position of the last obstacle
        let lastX = -1000; // If empty, assume last one was far left (safe to spawn)

        if (this.obstacles.length > 0) {
            lastX = this.obstacles[this.obstacles.length - 1].x;
        }

        // 2. Calculate Gap
        const currentGap = CANVAS.width - lastX;

        // 3. Determine Min Gap required (decreases slightly as you level up to make it harder)
        const minGap = 450 - (this.level * 10);

        // 4. Spawn Check
        if (currentGap > minGap) {
            // 5% chance per frame to spawn IF gap is clear
            if (Math.random() < 0.05) {
                const type = Math.random() > 0.6 ? 'block' : 'spike';
                // Double spike chance for higher levels
                if(this.level > 2 && Math.random() > 0.7) {
                    this.obstacles.push(new Obstacle(CANVAS.width, 'spike'));
                    this.obstacles.push(new Obstacle(CANVAS.width + 45, 'spike')); // Double spike
                } else {
                    this.obstacles.push(new Obstacle(CANVAS.width, type));
                }
            }
        }
    },

    updateHUD() {
        document.getElementById('levelDisplay').innerText = `LVL ${this.level.toString().padStart(2,'0')}`;
        document.getElementById('attemptDisplay').innerText = this.attempt;

        // Level complete at score 1000
        const pct = Math.min(100, Math.floor((this.score / 1000) * 100));
        document.getElementById('progressBar').style.width = `${pct}%`;
        document.getElementById('progressText').innerText = `${pct}%`;

        if (this.score > 1000) {
            this.state = 'PAUSE';
            this.showModal();
        }
    },

    showModal() {
        const d = LEVEL_DATA[this.level-1];
        document.getElementById('modalLevelNum').innerText = this.level.toString().padStart(2,'0');
        document.getElementById('modalTitle').innerText = d.title;
        document.getElementById('modalDesc').innerHTML = d.desc;
        document.getElementById('infoModal').classList.remove('hidden');
    },

    fail() {
        this.state = 'OVER';
        this.attempt++;
        Audio.crash();
        document.getElementById('failLevel').innerText = this.level.toString().padStart(2,'0');
        document.getElementById('gameOver').classList.remove('hidden');
    },

    restartLevel() {
        this.resetLevel();
    },

    loop() {
        if(this.state === 'PLAY') {
            CTX.clearRect(0,0, CANVAS.width, CANVAS.height);

            // --- Background Drawing ---
            const floorY = CANVAS.height - 150;

            // Sky Gradient
            const grad = CTX.createLinearGradient(0,0,0,CANVAS.height);
            grad.addColorStop(0, '#020005');
            grad.addColorStop(1, '#1e0b36');
            CTX.fillStyle = grad;
            CTX.fillRect(0,0, CANVAS.width, CANVAS.height);

            // 3D Grid Floor
            CTX.save();
            CTX.beginPath();
            CTX.moveTo(0, floorY);
            CTX.lineTo(CANVAS.width, floorY);
            CTX.strokeStyle = '#a855f7';
            CTX.lineWidth = 2;
            CTX.shadowBlur = 10;
            CTX.shadowColor = '#a855f7';
            CTX.stroke();

            // Moving Perspective Lines
            const offset = (this.score * this.speed) % 100;
            CTX.strokeStyle = 'rgba(168, 85, 247, 0.2)';
            CTX.lineWidth = 1;

            for(let x = -150; x < CANVAS.width + 150; x += 100) {
                // Perspective math to make floor look 3D
                CTX.beginPath();
                CTX.moveTo(x - offset, floorY);
                // Fan out the lines at bottom
                let bx = (x - offset - CANVAS.width/2) * 4 + CANVAS.width/2;
                CTX.lineTo(bx, CANVAS.height);
                CTX.stroke();
            }
            CTX.restore();

            // --- Game Updates ---
            this.score += 1;
            this.spawnObstacle(); // New Fixed Logic

            this.player.update();
            this.player.draw();

            this.obstacles.forEach((o, i) => {
                o.update(this.speed);
                o.draw();

                if(o.collide(this.player)) {
                    this.fail();
                }

                // Cleanup off-screen
                if(o.marked) this.obstacles.splice(i, 1);
            });

            this.updateHUD();
        }
        requestAnimationFrame(() => this.loop());
    }
};

// Start immediately on load if needed, or wait for button
window.onload = () => {
    Game.resize();
    // Pre-draw start screen
    CTX.fillStyle = '#050505';
    CTX.fillRect(0,0,CANVAS.width, CANVAS.height);
};
</script>
{% endblock %}